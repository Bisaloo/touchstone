<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benchmark Different Git Refs in One Run • touchstone</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Benchmark Different Git Refs in One Run">
<meta property="og:description" content="A common problem of benchmarking in continuous integration is
    that the computational power of the virtual machines that run the job
    varies over time.  This package allows users to benchmark two git refs
    of the same repo in a random sequence for better comparison.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">touchstone</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/inference.html">Inference</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lorenzwalthert/touchstone/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div id="touchstone" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#touchstone" class="anchor"></a>touchstone</h1></div>
<p>{touchstone} is a developer tool for benchmarking R pull requests with a focus on reliable relative measurement, uncertainty reporting and user convenience. The results are directly reported as a comment in the pull request.</p>
<p><img src="reference/figures/screenshot-pr-comment.png"></p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the package from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"touchstone"</span><span class="op">)</span></code></pre></div>
</div>
<div id="motivation" class="section level2">
<h2 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h2>
<p>The motivation for touchstone is to provide accurate benchmarking results for package developers. The following insights were the motivation:</p>
<ul>
<li><p><strong>Compute power in GitHub Action VMs varies too much for reliable isolated benchmarks</strong>: Experience with styler showed that a variation <a href="https://github.com/r-lib/styler/pull/679">around 30%</a> for identical benchmarking code is possible. The solution to this is to benchmark the two branches in one CI/CD run and look at <em>relative difference</em> between branches. This matters in particular when running one iteration of a benchmark takes long (&gt;&gt; a few seconds) and speed implications are not huge.</p></li>
<li><p><strong>Timelines of absolute changes are mostly noise:</strong> Maintaining a timeline of absolute benchmark times is of limited use because of the first bullet, at least when benchmark results don’t vary significantly (&gt; 50%).</p></li>
<li><p><strong>Dependencies should be identical across versions:</strong> R and package versions of dependencies must be fixed via <a href="http://packagemanager.rstudio.com">RSPM</a> to allow as much continuation as possible anyways. Changing the timestamp of RSPM can happen in PRs that are only dedicated to dependency updates.</p></li>
<li><p><strong>Pull requests are a natural unit for measuring speed:</strong> Linking benchmarking to pull requests make sense because you can easily benchmark any revision against any other. Just open a pull request from one branch on another. You can also easily keep track of how performance of your development version evolves by opening a PR against a branch with the released version. No need to ever merge these. Once you release a new version of you package, you can change the target branch of the pull request to start anew. The pull request comments will preserve the information.</p></li>
</ul>
</div>
<div id="conceptual" class="section level2">
<h2 class="hasAnchor">
<a href="#conceptual" class="anchor"></a>Conceptual</h2>
<p>For your PR branch and the target branch, {touchstone} will:</p>
<ul>
<li><p>build the two versions of the package in isolated libraries.</p></li>
<li><p>run the code you want to benchmark, many times, in <a href="https://lorenzwalthert.github.io/touchstone/articles/inference.html#sampling">random order</a>. This ensures the accurate measurement of relative differences between the branches.</p></li>
</ul>
<p>Once done with the measurements, it will</p>
<ul>
<li><p>comment the results of the benchmarking on the PR.</p></li>
<li><p>create visualizations as Github Action artifacts that show how the distribution of the timings for both branches.</p></li>
</ul>
</div>
<div id="proposed-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#proposed-workflow" class="anchor"></a>Proposed Workflow</h2>
<p>Initialize {touchstone} in your repo with</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">touchstone</span><span class="fu">::</span><span class="fu"><a href="reference/use_touchstone.html">use_touchstone</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will:</p>
<ul>
<li>
<p>create a <code>touchstone</code> directory in the repo root with:</p>
<ul>
<li>
<code>config.json</code> that defines how to run your benchmark. In particular, you can define a <code>benchmarking_repo</code>, that is, a repo you need to run your bench mark (use <code>""</code> if you don’t need an additional git repo checked out for your benchmark). This repo will be cloned into <code>benchmarking_path</code>. For example to benchmark {styler}, we format the {here} package with <code>style_pkg()</code> that is not part of the {styler} repo, but with the below config, will be located at <code>touchstone/sources/here</code> during benchmarking. The code you want to benchmark comes from the benchmarked repo, which in our case is the root from where you call <code><a href="reference/use_touchstone.html">use_touchstone()</a></code> and hence does not need to be defined explicitly.</li>
</ul>
<!-- end list --><div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">{</span> </span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="dt">"benchmarking_repo"</span><span class="fu">:</span> <span class="st">"lorenzwalthert/here"</span><span class="fu">,</span> </span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="dt">"benchmarking_ref"</span><span class="fu">:</span> <span class="st">"ca9c8e69c727def88d8ba1c8b85b0e0bcea87b3f"</span><span class="fu">,</span> </span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="dt">"benchmarking_path"</span><span class="fu">:</span> <span class="st">"touchstone/sources/here"</span><span class="fu">,</span> </span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="dt">"os"</span><span class="fu">:</span> <span class="st">"ubuntu-18.04"</span><span class="fu">,</span> </span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="dt">"r"</span><span class="fu">:</span> <span class="st">"4.0.0"</span><span class="fu">,</span> </span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="dt">"rspm"</span><span class="fu">:</span> <span class="st">"https://packagemanager.rstudio.com/all/__linux__/bionic/291"</span> </span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="fu">}</span></span></code></pre></div>
<ul>
<li>
<code>script.R</code>, the script that runs the benchmark.</li>
</ul>
<!-- end list --><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">touchstone</span><span class="fu">::</span><span class="fu"><a href="reference/refs_install.html">refs_install</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># installs branches to benchmark</span>

<span class="co"># benchmark a function call from your package (two calls per branch)</span>
<span class="fu">touchstone</span><span class="fu">::</span><span class="fu"><a href="reference/benchmark_run_ref.html">benchmark_run_ref</a></span><span class="op">(</span>
random_test <span class="op">=</span> <span class="fu">yourpkg</span><span class="fu">::</span><span class="fu">fun</span><span class="op">(</span><span class="op">)</span>,
n <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span>

<span class="co"># create artifacts used downstream in the GitHub Action</span>
<span class="fu">touchstone</span><span class="fu">::</span><span class="fu"><a href="reference/benchmarks_analyze.html">benchmarks_analyze</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</li>
<li><p>write the workflow files you need for touchstone into <code>.github/workflows/</code> to invoke your touchstone script.</p></li>
</ul>
<p>Note that these files must be committed to the default branch before {touchstone} continuous benchmarking will be triggered for new PRs.</p>
<p>If you want to call the script interactively, use <code>run_script</code>()<code>(an enhanced version of</code>base::source()<code>) for various technical reasons described in the help file. Note that</code>benchmark_run_ref()` will check out different branches and should therefore be the only process running in the directory and only in a clean git working directory.</p>
</div>
<div id="status" class="section level2">
<h2 class="hasAnchor">
<a href="#status" class="anchor"></a>Status</h2>
<p>This package is experimental. You can see an example usage in <a href="https://github.com/r-lib/styler/pull/799">{styler}</a>.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/lorenzwalthert/touchstone/">https://​github.com/​lorenzwalthert/​touchstone/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/lorenzwalthert/touchstone/issues">https://​github.com/​lorenzwalthert/​touchstone/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>
<a href="https://lorenzwalthert.netlify.com">Lorenz Walthert</a> <br><small class="roles"> Author, maintainer </small>  </li>
<li>Jacob Wujciak-Jens <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-7281-3989" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://www.tidyverse.org/lifecycle/#experimental"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
<li><a href="https://github.com/lorenzwalthert/touchstone/actions"><img src="https://github.com/lorenzwalthert/touchstone/workflows/R-CMD-check/badge.svg" alt="R build status"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://lorenzwalthert.netlify.com">Lorenz Walthert</a>, Jacob Wujciak-Jens.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
